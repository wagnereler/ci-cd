name: CI/CD

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [staging, main]
  push:
    branches: [staging, main]
  workflow_dispatch:
    inputs:
      action:
        description: "Action to run"
        required: true
        default: rollback
        type: choice
        options:
          - rollback
      environment:
        description: "Target environment"
        required: true
        default: staging
        type: choice
        options:
          - staging
          - prod
      image:
        description: "Full image ref for rollback (ex: registry/repo:tag)"
        required: true
        type: string

env:
  IMAGE_NAME: nexadesk-api

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        if: ${{ hashFiles('api/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        if: ${{ hashFiles('api/package.json') != '' }}
        working-directory: api
        run: npm ci

      - name: Run lint
        if: ${{ hashFiles('api/package.json') != '' }}
        working-directory: api
        run: npm run lint --if-present

      - name: Run tests
        if: ${{ hashFiles('api/package.json') != '' }}
        working-directory: api
        run: npm test --if-present

  build-and-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: DOCKER
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main') }}
    outputs:
      image: ${{ steps.meta.outputs.image }}
      target_env: ${{ steps.target.outputs.target_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate registry credentials
        run: |
          if [ -z "${{ secrets.REGISTRY_USER }}" ]; then
            echo "::error::Secret REGISTRY_USER is empty or unavailable in this run."
            exit 1
          fi
          if [ -z "${{ secrets.REGISTRY_PASS }}" ]; then
            echo "::error::Secret REGISTRY_PASS is empty or unavailable in this run."
            exit 1
          fi

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY_URL || 'docker.io' }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASS }}

      - name: Build and push image
        id: meta
        run: |
          REGISTRY=${{ secrets.REGISTRY_URL || 'docker.io' }}
          IMAGE=$REGISTRY/${{ env.IMAGE_NAME }}:${{ github.sha }}
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          docker build -t "$IMAGE" ./api
          docker push "$IMAGE"

      - name: Define target environment
        id: target
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "target_env=prod" >> "$GITHUB_OUTPUT"
          else
            echo "target_env=staging" >> "$GITHUB_OUTPUT"
          fi

  promote-by-pr:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: ${{ needs.build-and-push.result == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update GitOps image file
        run: |
          ENV_NAME='${{ needs.build-and-push.outputs.target_env }}'
          IMAGE='${{ needs.build-and-push.outputs.image }}'
          for BASE in infra/environments environments; do
            mkdir -p "$BASE/$ENV_NAME/api"
            printf '# arquivo controlado por CI para promover imagens no GitOps\n# conteudo = registry_url/image_name:tag\n%s\n' "$IMAGE" > "$BASE/$ENV_NAME/api/image.txt"
          done

      - name: Create promotion PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(gitops): promote ${{ needs.build-and-push.outputs.image }} to ${{ needs.build-and-push.outputs.target_env }}"
          title: "promote: ${{ needs.build-and-push.outputs.target_env }} -> ${{ github.sha }}"
          body: "Automated image promotion to `${{ needs.build-and-push.outputs.target_env }}`."
          base: ${{ github.ref_name }}
          branch: promote/${{ needs.build-and-push.outputs.target_env }}-${{ github.sha }}

  rollback-by-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate rollback image
        run: |
          if [ -z "${{ github.event.inputs.image }}" ]; then
            echo "Rollback image is required" >&2
            exit 1
          fi

      - name: Write rollback image to target environment
        run: |
          ENV_NAME='${{ github.event.inputs.environment }}'
          IMAGE='${{ github.event.inputs.image }}'
          for BASE in infra/environments environments; do
            mkdir -p "$BASE/$ENV_NAME/api"
            printf '# arquivo controlado por CI para promover imagens no GitOps\n# conteudo = registry_url/image_name:tag\n%s\n' "$IMAGE" > "$BASE/$ENV_NAME/api/image.txt"
          done

      - name: Create rollback PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(gitops): rollback ${{ github.event.inputs.environment }} to ${{ github.event.inputs.image }}"
          title: "rollback: ${{ github.event.inputs.environment }} -> ${{ github.event.inputs.image }}"
          body: "Manual rollback request to `${{ github.event.inputs.environment }}` using image `${{ github.event.inputs.image }}`."
          base: ${{ github.event.inputs.environment == 'prod' && 'main' || 'staging' }}
          branch: rollback/${{ github.event.inputs.environment }}-${{ github.run_id }}
